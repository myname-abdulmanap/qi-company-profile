---
import "../styles/formJob.css";

// Props dari halaman
const { slug, locations = [] } = Astro.props;

// Helper untuk menampilkan slug human-readable (tetap seperti sebelumnya)
function formatSlugForDisplay(slug: string) {
  return slug
    .split("-")
    .map((word) => word.replace(/\d+/g, "").trim())
    .filter((word) => word.length > 0)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

const displayText = formatSlugForDisplay(slug);

// Ambil BASE API dari ENV (gunakan URL penuh)
// - .env.development : PUBLIC_API_BASE=http://localhost:4000/api/v1
// - .env.production  : PUBLIC_API_BASE=https://qualita-indonesia.com/api/api/v1
const API_BASE = (import.meta.env.PUBLIC_API_BASE || "/api/v1");
---

<section class="job-application" id="job-application" data-api-base={API_BASE}>
  <div class="job-application-container">
    <div class="section-title fade-in">
      <br />
      <br/>
      <h2><i class="fas fa-briefcase"></i> Job Application</h2>
      <p>Join our team at Qualita Indonesia</p>
      <p>Fill out the form below to apply for available positions</p>
    </div>

    <form class="job-form fade-in" id="job-form" enctype="multipart/form-data">
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-briefcase"></i>
          Job Information
        </h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="posisi" class="required">
              <i class="fas fa-clipboard-list"></i>
              Position Applied For
            </label>
            <input 
              type="text" 
              id="posisi" 
              name="posisi"
              value={slug} 
              readonly 
            />
          </div>

          <div class="form-group">
            <label for="lokasiPenempatan" class="required">
              <i class="fas fa-map-marker-alt"></i>
              Job Location
            </label>
            <select id="lokasiPenempatan" name="lokasiPenempatan" required>
              <option value="">Select Location</option>
              {
                locations.length > 0
                  ? locations.map((loc: any) => (
                      <option value={loc.name} disabled={loc.status === "closed"}>
                        {loc.name} {loc.status === "closed" ? "(Closed)" : "(Available)"}
                      </option>
                    ))
                  : <option value="Not Specified">Not Specified</option>
              }
            </select>
            <div class="validation-message"></div>
          </div>
        </div>
      </div>

      <!-- Personal Info -->
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-user"></i>
          Personal Information
        </h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="nama" class="required">
              <i class="fas fa-id-card"></i>
              Full Name
            </label>
            <input 
              type="text" 
              id="nama" 
              name="nama" 
              required 
              placeholder="Enter your full name"
            />
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label for="gender" class="required">
              <i class="fas fa-venus-mars"></i>
              Gender
            </label>
            <select id="gender" name="gender" required>
              <option value="">Select Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            <div class="validation-message"></div>
          </div>
          
          <div class="form-group">
            <label for="email" class="required">
              <i class="fas fa-envelope"></i>
              Email
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              placeholder="your.email@example.com"
            />
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label for="nomorTelepon" class="required">
              <i class="fas fa-phone"></i>
              Phone Number
            </label>
            <input 
              type="tel" 
              id="nomorTelepon" 
              name="nomorTelepon" 
              required 
              placeholder="08xx-xxxx-xxxx"
            />
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label for="tanggalLahir" class="required">
              <i class="fas fa-calendar-alt"></i>
              Birth Date
            </label>
            <input 
              type="date" 
              id="tanggalLahir" 
              name="tanggalLahir" 
              required
            />
            <div class="validation-message"></div>
          </div>

          <div class="form-group">
            <label for="alamat" class="required">
              <i class="fas fa-home"></i>
              Address (KTP)
            </label>
            <input 
              type="text" 
              id="alamat" 
              name="alamat" 
              required 
              placeholder="Enter your address as per KTP"
            />
            <div class="validation-message"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="alamatDomisili" class="required">
            <i class="fas fa-map-marker-alt"></i>
            Domicile Address (with map)
          </label>
          <div class="location-input-container">
            <input 
              type="text" 
              id="alamatDomisili" 
              name="alamatDomisili" 
              placeholder="Click map or use current location" 
              required
            /><br />
            <button type="button" id="location-btn" class="location-btn">
              <i class="fas fa-location-arrow"></i>
              Use Current Location
            </button>
          </div>
          <div id="map" class="map-container"></div>
          <input type="hidden" id="locationLat" name="locationLat" />
          <input type="hidden" id="locationLng" name="locationLng" />
          <div id="location-coordinates-display" style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-left: 3px solid #0284c7; border-radius: 4px; font-size: 13px; color: #0c4a6e; display: none;">
            <i class="fas fa-map-pin" style="margin-right: 6px;"></i>
            <strong>Coordinates:</strong> <span id="location-coords-text">-</span>
          </div>
          <small class="form-note">
            <i class="fas fa-info-circle"></i>
            Click map to select location or use current location
          </small>
        </div>
      </div>

      <!-- Uploads -->
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-upload"></i>
          Document Uploads
        </h3>
        <div class="form-group">
          <label for="cv" class="required">
            <i class="fas fa-file-alt"></i>
            CV/Resume
          </label>
          <input 
            type="file" 
            id="cv" 
            name="cv" 
            accept=".pdf,.doc,.docx,.txt" 
            required 
          />
          <small class="form-note">Accepted formats: PDF, DOC, DOCX (Max: 3 MB)</small>
          <div class="validation-message"></div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="photo" class="required">
              <i class="fas fa-camera"></i>
              Photo (Personal)
            </label>
            <input 
              type="file" 
              id="photo" 
              name="photo" 
              accept="image/*" 
              required
            />
            <small class="form-note">Accepted formats: PNG, JPG (Max: 2MB)</small>
          </div>

          <div class="form-group">
            <label for="ktp" class="required">
              <i class="fas fa-id-card-alt"></i>
              ID Card (KTP)
            </label>
            <input 
              type="file" 
              id="ktp" 
              name="ktp" 
              accept="image/*,.pdf" 
              required
            />
            <small class="form-note">Accepted formats: PNG, JPG (Max: 2 MB)</small>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="kk" class="required">
              <i class="fas fa-users"></i>
              Family Card (KK)
            </label>
            <input 
              type="file" 
              id="kk" 
              name="kk" 
              accept="image/*,.pdf" 
              required
            />
            <small class="form-note">Accepted formats: PNG, JPG (Max: 2 MB)</small>
          </div>

          <div class="form-group">
            <label for="ijazah" class="required">
              <i class="fas fa-certificate"></i>
              Ijazah/Transcript
            </label>
            <input 
              type="file" 
              id="ijazah" 
              name="ijazah" 
              accept="image/*,.pdf" 
              required
            />
            <small class="form-note">Accepted formats: PNG, JPG (Max: 2 MB)</small>
          </div>
        </div>
      </div>

      <!-- Education -->
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-graduation-cap"></i>
          Education (Minimum 1 entry required)
        </h3>
        <div id="education-container"></div>
        <button type="button" class="btn secondary" id="add-education">
          <i class="fas fa-plus"></i>
          Add Education
        </button>
        <input type="hidden" id="pendidikanTerakhir" name="pendidikanTerakhir" />
      </div>

      <!-- Work Experience -->
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-briefcase"></i>
          Work Experience (Minimum 1 entry required)
        </h3>
        <div id="experience-container"></div>
        <button type="button" class="btn secondary" id="add-experience">
          <i class="fas fa-plus"></i>
          Add Experience
        </button>
        <input type="hidden" id="pengalamanKerja" name="pengalamanKerja" />
      </div>

      <!-- Skills -->
      <div class="form-section">
        <h3 class="section-subtitle">
          <i class="fas fa-cogs"></i>
          Skills & Information
        </h3>

        <div class="form-group skill-input-group">
          <label for="skill" class="required">
            <i class="fas fa-star"></i>
            Skills
          </label>
          <div class="skill-input-container">
            <input 
              type="text" 
              id="skill" 
              name="skill" 
              required 
              placeholder="Type skills (e.g., JavaScript, React, Python)"
              autocomplete="off"
            />
            <datalist id="skill-suggestions"></datalist>
          </div>
          <small class="form-note">
            <i class="fas fa-lightbulb"></i>
            Type and select from suggestions or enter custom skills
          </small>
          <div class="validation-message"></div>
        </div>

        <div class="form-group">
          <label for="bahasa" class="required">
            <i class="fas fa-language"></i>
            Languages
          </label>
            <input 
              type="text" 
              id="bahasa" 
              name="bahasa" 
              required 
              placeholder="e.g., Indonesian (Native), English (Fluent)"
            />
          <div class="validation-message"></div>
        </div>

        <div class="form-group">
          <label for="sertifikasi">
            <i class="fas fa-award"></i>
            Certifications
          </label>
          <input 
            type="text" 
            id="sertifikasi" 
            name="sertifikasi" 
            placeholder="List your certifications"
          />
          <small class="form-note">
            <i class="fas fa-lightbulb"></i>
            Separated with commas (e.g., AWS Certified Solutions Architect, PMP)  
          </small>
        </div>

        <div class="form-group">
          <label for="linkedin">
            <i class="fab fa-linkedin"></i>
            LinkedIn Profile
          </label>
          <input 
            type="url" 
            id="linkedin" 
            name="linkedin" 
            placeholder="https://linkedin.com/in/yourprofile"
          />
        </div>

        <div class="form-group">
          <label for="portfolio">
            <i class="fas fa-globe"></i>
            Portfolio Website
          </label>
          <input 
            type="url" 
            id="portfolio" 
            name="portfolio" 
            placeholder="https://yourportfolio.com"
          />
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button type="submit" id="submit-btn" class="btn primary">
          <i class="fas fa-paper-plane"></i>
          Submit Application
        </button>
        <a href={`/careers/${slug}`} class="btn secondary">Back to Detail</a> 
      </div>

      <div class="status" id="status"></div>
    </form>
  </div>
</section>

<!-- External Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// =====================
// Utils: API base & join
// =====================
function getApiBase() {
  const root = document.querySelector('#job-application');
  return (root?.dataset?.apiBase || '/api/v1').replace(/\/+$/,'');
}
function apiJoin(path) {
  const base = getApiBase();
  const clean = String(path).replace(/^\/+/, '');
  return `${base}/${clean}`;
}

// =====================
// Production-only console mute
// =====================
(function disableConsoleInProd(){
  try {
    // Astroland way (dengan bundling), fallback sederhana:
    const isProd = true; // dibaca saat client (build prod) — cukup pakai true agar aman
    if (isProd) {
      const noop = ()=>{};
      console.log = noop; console.debug = noop; console.info = noop;
      // biarkan warn/error untuk debugging jika perlu; hapus jika ingin total sunyi:
      // console.warn = noop; console.error = noop;
    }
  } catch {}
})();

// =====================
// Geocode helpers (via backend proxy)
// =====================
async function reverseGeocode(lat, lon) {
  const url = apiJoin(`proxy/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// (opsional kalau mau dipakai di tombol pencarian alamat text)
// async function searchGeocode(q, limit=1) {
//   const url = apiJoin(`proxy/geocode?q=${encodeURIComponent(q)}&limit=${limit}`);
//   const res = await fetch(url);
//   if (!res.ok) throw new Error(`HTTP ${res.status}`);
//   return res.json();
// }

// =====================
// Form manager
// =====================
class JobApplicationManager {
  constructor() {
    this.educationCount = 0;
    this.experienceCount = 0;
    this.form = document.getElementById("job-form");
    this.status = document.getElementById("status");
    this.map = null;
    this.marker = null;

    this.init();
    this.initSkillSystem();
  }

  init() {
    this.initMap();
    this.bindEvents();
    this.addEducation();
    this.addExperience();
    this.initFileValidation();
  }

  bindEvents() {
    document.getElementById("location-btn")?.addEventListener("click", () => this.useCurrentLocation());
    document.getElementById("add-education")?.addEventListener("click", () => this.addEducation());
    document.getElementById("add-experience")?.addEventListener("click", () => this.addExperience());
    this.form.addEventListener("submit", (e) => this.handleSubmit(e));

    document.addEventListener('change', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.matches('[name^="tanggalMulaiKerja"], [name^="tanggalSelesaiKerja"], [name^="statusKerja"]')) {
        const entry = t.closest('.experience-entry');
        if (entry) this.calculateDuration(entry);
      }
    });
  }

  // ===== Skill suggestions (static) =====
  initSkillSystem() {
    this.skillsDatabase = [
      'JavaScript','TypeScript','Python','Java','C++','C#','PHP','Ruby','Go','Rust',
      'Swift','Kotlin','Dart','Scala','R','MATLAB','C','Objective-C',
      'Web Development','Web Developer','Web Design','Web Designer',
      'React','React Developer','Vue.js','Vue Developer','Angular','Angular Developer',
      'Next.js','Nuxt.js','Svelte','jQuery','HTML5','CSS3',
      'Sass','Less','Tailwind CSS','Bootstrap','Material-UI','Ant Design','Chakra UI',
      'Frontend Development','Frontend Developer','UI Developer',
      'Node.js','Node Developer','Express.js','Django','Django Developer','Flask',
      'Spring Boot','Laravel','Laravel Developer','Ruby on Rails',
      'ASP.NET','FastAPI','Nest.js','Koa.js','Gin','Fiber',
      'Backend Development','Backend Developer','API Development',
      'Full Stack Developer','Full Stack Development','MERN Stack','MEAN Stack',
      'MySQL','PostgreSQL','MongoDB','Redis','SQLite','Oracle','SQL Server',
      'Elasticsearch','Firebase','Supabase','DynamoDB','Cassandra',
      'Database Administration','Database Design',
      'AWS','AWS Developer','Google Cloud','GCP','Azure','Docker','Kubernetes',
      'Jenkins','GitLab CI','GitHub Actions','Terraform','Ansible','Linux','Nginx','Apache',
      'DevOps Engineer','Cloud Engineer','System Administrator',
      'Figma','Adobe Photoshop','Adobe Illustrator','Sketch','Adobe XD','InVision',
      'Canva','UI/UX Design','UI Designer','UX Designer','Graphic Design','Graphic Designer',
      'Wireframing','Prototyping','User Research',
      'React Native','React Native Developer','Flutter','Flutter Developer',
      'iOS Development','iOS Developer','Android Development','Android Developer',
      'Xamarin','Ionic','Cordova','Swift UI','Jetpack Compose',
      'Mobile Developer','Mobile Development',
      'Data Science','Data Scientist','Data Analyst','Data Analysis',
      'Machine Learning','ML Engineer','Deep Learning','AI Developer',
      'Data Engineering','Data Engineer','Big Data',
      'Quality Assurance','QA Engineer','Software Testing','Test Automation',
      'Selenium','Jest','Cypress','Unit Testing',
      'Git','GitHub','GitLab','Bitbucket','VS Code','IntelliJ IDEA','Postman',
      'Jira','Slack','Notion','Trello','Asana',
      'Premiere Pro','After Effects','Final Cut Pro','Video Editing',
      'Microsoft Office','Excel','PowerPoint','Word','Google Workspace',
      'Communication','Teamwork','Leadership','Problem Solving',
      'Time Management','Project Management','Agile','Scrum',
      'Critical Thinking','Creativity','Adaptability'
    ];
    this.setupSkillInput();
  }

  setupSkillInput() {
    const skillInput = document.getElementById('skill');
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'skill-suggestions';
    suggestionsContainer.style.cssText = `
      position: absolute;
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    skillInput.parentElement.style.position = 'relative';
    skillInput.parentElement.appendChild(suggestionsContainer);

    skillInput.addEventListener('input', (e) => {
      const value = (e.target.value || '').toLowerCase().trim();

      const validationMessage = skillInput.parentElement.parentElement.querySelector('.validation-message');
      if (validationMessage) {
        validationMessage.textContent = '';
        validationMessage.className = 'validation-message';
      }
      skillInput.classList.remove('error', 'success');

      if (value.length < 2) {
        suggestionsContainer.style.display = 'none';
        suggestionsContainer.innerHTML = '';
        return;
      }

      const matches = this.skillsDatabase
        .filter(skill => skill.toLowerCase().includes(value))
        .slice(0, 10);

      if (matches.length > 0) {
        suggestionsContainer.innerHTML = matches.map(skill => `
          <div class="suggestion-item" style="
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
          " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
            <i class="fas fa-lightbulb" style="color: #4a90e2; margin-right: 8px;"></i>
            ${this.highlightMatch(skill, value)}
          </div>
        `).join('');
        suggestionsContainer.style.display = 'block';

        suggestionsContainer.querySelectorAll('.suggestion-item').forEach((item, idx) => {
          item.addEventListener('click', () => {
            skillInput.value = matches[idx];
            suggestionsContainer.style.display = 'none';
            skillInput.focus();
          });
        });
      } else {
        suggestionsContainer.style.display = 'none';
        suggestionsContainer.innerHTML = '';
      }
    });

    document.addEventListener('click', (e) => {
      if (!skillInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        suggestionsContainer.style.display = 'none';
      }
    });

    skillInput.addEventListener('keydown', (e) => {
      const items = suggestionsContainer.querySelectorAll('.suggestion-item');
      if (items.length === 0) return;

      let currentIndex = -1;
      items.forEach((item, index) => {
        if (item.classList.contains('active')) currentIndex = index;
      });

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex < items.length - 1) {
          if (currentIndex >= 0) items[currentIndex].classList.remove('active');
          currentIndex++;
          items[currentIndex].classList.add('active');
          items[currentIndex].style.background = '#f5f5f5';
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex > 0) {
          items[currentIndex].classList.remove('active');
          items[currentIndex].style.background = 'white';
          currentIndex--;
          items[currentIndex].classList.add('active');
          items[currentIndex].style.background = '#f5f5f5';
        }
      } else if (e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        items[currentIndex].dispatchEvent(new Event('click'));
      } else if (e.key === 'Escape') {
        suggestionsContainer.style.display = 'none';
      }
    });
  }

  highlightMatch(text, query) {
    const idx = text.toLowerCase().indexOf(query);
    if (idx === -1) return text;
    const before = text.substring(0, idx);
    const match = text.substring(idx, idx + query.length);
    const after = text.substring(idx + query.length);
    return `${before}<strong style="color: #4a90e2;">${match}</strong>${after}`;
  }

  // ===== File validation =====
  initFileValidation() {
    const fileInputs = this.form.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', (e) => this.validateFile(e.target));
    });
  }

  validateFile(input) {
    const file = input.files?.[0];
    if (!file) return true;
    const maxSize = input.id === 'cv' ? 5 * 1024 * 1024 : 2 * 1024 * 1024;
    if (file.size > maxSize) {
      this.showStatus(`File "${file.name}" too large. Maximum size: ${maxSize / (1024 * 1024)}MB`, 'error');
      input.value = '';
      return false;
    }
    return true;
  }

  // ===== Map & Geolocation =====
  initMap() {
    this.map = L.map("map").setView([-6.2088, 106.8456], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors'
    }).addTo(this.map);
    this.map.on("click", (e) => this.setLocation(e.latlng));
  }

  async setLocation(latlng) {
    if (this.marker) this.map.removeLayer(this.marker);
    this.marker = L.marker(latlng).addTo(this.map);
    this.marker.bindPopup('<i class="fas fa-spinner fa-spin"></i> Getting address...').openPopup();

    try {
      // PAKAI PROXY BACKEND (bukan langsung Nominatim)
      const data = await reverseGeocode(latlng.lat, latlng.lng);
      const address = data?.display_name || "Selected Location";
      const link = `https://www.google.com/maps?q=${latlng.lat},${latlng.lng}`;
      document.getElementById("alamatDomisili").value = `${address} - ${link}`;
      this.marker.bindPopup(`<strong>Selected Location</strong><br>${address}`).openPopup();
    } catch {
      const link = `https://www.google.com/maps?q=${latlng.lat},${latlng.lng}`;
      document.getElementById("alamatDomisili").value = link;
      this.marker.bindPopup('<strong>Selected Location</strong><br>Coordinates: ' + 
        `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`).openPopup();
    }

    document.getElementById("locationLat").value = latlng.lat;
    document.getElementById("locationLng").value = latlng.lng;

    const coordsDisplay = document.getElementById("location-coordinates-display");
    const coordsText = document.getElementById("location-coords-text");
    coordsText.textContent = `Lat: ${latlng.lat.toFixed(6)}, Lng: ${latlng.lng.toFixed(6)}`;
    coordsDisplay.style.display = "block";
  }

  useCurrentLocation() {
    if (!navigator.geolocation) {
      this.showStatus("Geolocation is not supported by this browser", "error");
      return;
    }

    this.showStatus("Requesting location permission...", "loading");

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const latlng = { lat: position.coords.latitude, lng: position.coords.longitude };
        this.map.setView(latlng, 15);
        this.setLocation(latlng);
        this.showStatus("Location found successfully!", "success");
      },
      (error) => {
        let message = "Unable to get your location";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = "Location access denied. Please:<br>1. Allow location access in your browser settings<br>2. Make sure location services are enabled on your device<br>3. Try refreshing the page and allow location when prompted";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "Location information unavailable. Please check if:<br>1. GPS is enabled on your device<br>2. You're not in airplane mode<br>3. You have good GPS signal";
            break;
          case error.TIMEOUT:
            message = "Location request timed out. Please:<br>1. Check your GPS signal<br>2. Try again in a moment";
            break;
        }
        this.showStatus(message, "error");
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }

  // ===== Dynamic entries =====
  addEducation() {
    this.educationCount++;
    const container = document.getElementById("education-container");
    const div = document.createElement("div");
    div.classList.add("education-entry");
    div.setAttribute('data-entry-id', String(this.educationCount));
    div.innerHTML = `
      ${this.educationCount > 1 ? `<button type="button" class="remove-btn" onclick="window.jobApp.removeEducation(${this.educationCount})"><i class="fas fa-times"></i></button>` : ''}
      <div class="form-grid-3">
        <div class="form-group">
          <label><i class="fas fa-layer-group"></i> Level *</label>
          <select name="jenjang${this.educationCount}" required>
            <option value="">Select Level</option>
            <option value="SD">SD (Elementary)</option>
            <option value="SMP">SMP (Middle School)</option>
            <option value="SMA/SMK">SMA/SMK</option>
            <option value="D3">D3 (Diploma)</option>
            <option value="S1">S1 (Bachelor)</option>
            <option value="S2">S2 (Master)</option>
            <option value="S3">S3 (PhD)</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Major *</label>
          <input type="text" name="jurusan${this.educationCount}" required placeholder="e.g., Computer Science" />
        </div>
        <div class="form-group">
          <label><i class="fas fa-university"></i> Institution *</label>
          <input type="text" name="institusi${this.educationCount}" required placeholder="e.g., University of Indonesia" />
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label><i class="fas fa-calendar-plus"></i> Start Year *</label>
          <input type="number" name="tahunMulai${this.educationCount}" required min="1980" max="2030" placeholder="2020" />
        </div>
        <div class="form-group">
          <label><i class="fas fa-calendar-check"></i> Graduation Year *</label>
          <input type="number" name="tahunLulus${this.educationCount}" required min="1980" max="2030" placeholder="2024" />
        </div>
      </div>
    `;
    container.appendChild(div);
  }

  removeEducation(id) {
    const entries = document.querySelectorAll('.education-entry');
    if (entries.length <= 1) {
      this.showStatus("At least one education entry is required", "error");
      return;
    }
    const entry = document.querySelector(`.education-entry[data-entry-id="${id}"]`);
    if (entry) entry.remove();
  }

  addExperience() {
    this.experienceCount++;
    const container = document.getElementById("experience-container");
    const div = document.createElement("div");
    div.classList.add("experience-entry");
    div.setAttribute('data-entry-id', String(this.experienceCount));
    div.innerHTML = `
      ${this.experienceCount > 1 ? `<button type="button" class="remove-btn" onclick="window.jobApp.removeExperience(${this.experienceCount})"><i class="fas fa-times"></i></button>` : ''}
      <div class="form-grid-3">
        <div class="form-group">
          <label><i class="fas fa-user-tie"></i> Position *</label>
          <input type="text" name="jabatan${this.experienceCount}" required placeholder="e.g., Software Developer" />
        </div>
        <div class="form-group">
          <label><i class="fas fa-building"></i> Company *</label>
          <input type="text" name="perusahaan${this.experienceCount}" required placeholder="e.g., Tech Company Ltd" />
        </div>
        <div class="form-group">
          <label><i class="fas fa-info-circle"></i> Status *</label>
          <select name="statusKerja${this.experienceCount}" required>
            <option value="">Select Status</option>
            <option value="Still Working">Still Working</option>
            <option value="No Longer Working">No Longer Working</option>
          </select>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label><i class="fas fa-calendar-plus"></i> Start Date *</label>
          <input type="date" name="tanggalMulaiKerja${this.experienceCount}" required />
        </div>
        <div class="form-group end-date-group">
          <label><i class="fas fa-calendar-minus"></i> End Date</label>
          <input type="date" name="tanggalSelesaiKerja${this.experienceCount}" />
        </div>
      </div>
      <div class="form-group">
        <label><i class="fas fa-clock"></i> Duration</label>
        <input type="text" name="durasiKerja${this.experienceCount}" readonly placeholder="Duration will be calculated automatically" class="duration-field" />
      </div>
    `;
    container.appendChild(div);
  }

  removeExperience(id) {
    const entries = document.querySelectorAll('.experience-entry');
    if (entries.length <= 1) {
      this.showStatus("At least one work experience entry is required", "error");
      return;
    }
    const entry = document.querySelector(`.experience-entry[data-entry-id="${id}"]`);
    if (entry) entry.remove();
  }

  // ===== Collect & format =====
  collectEducation() {
    const entries = document.querySelectorAll(".education-entry");
    const list = [];
    entries.forEach((entry) => {
      const num = entry.getAttribute('data-entry-id');
      const jenjang = entry.querySelector(`select[name="jenjang${num}"]`)?.value?.trim() || '';
      const jurusan = entry.querySelector(`input[name="jurusan${num}"]`)?.value?.trim() || '';
      const institusi = entry.querySelector(`input[name="institusi${num}"]`)?.value?.trim() || '';
      const mulai = entry.querySelector(`input[name="tahunMulai${num}"]`)?.value?.trim() || '';
      const lulus = entry.querySelector(`input[name="tahunLulus${num}"]`)?.value?.trim() || '';
      if (jenjang && jurusan && institusi && mulai && lulus) {
        list.push(`${jenjang} ${jurusan} - ${institusi} - ${mulai} - ${lulus}`);
      }
    });
    return list;
  }

  collectExperience() {
    const entries = document.querySelectorAll(".experience-entry");
    const list = [];
    entries.forEach((entry) => {
      const num = entry.getAttribute('data-entry-id');
      const jabatan = entry.querySelector(`input[name="jabatan${num}"]`)?.value?.trim() || '';
      const perusahaan = entry.querySelector(`input[name="perusahaan${num}"]`)?.value?.trim() || '';
      const mulai = entry.querySelector(`input[name="tanggalMulaiKerja${num}"]`)?.value?.trim() || '';
      const selesai = entry.querySelector(`input[name="tanggalSelesaiKerja${num}"]`)?.value?.trim() || "Present";
      const status = entry.querySelector(`select[name="statusKerja${num}"]`)?.value?.trim() || '';
      const durasi = entry.querySelector(`input[name="durasiKerja${num}"]`)?.value?.trim() || '';

      if (jabatan && perusahaan && mulai && status) {
        const startFormatted = this.formatDateForDisplay(mulai);
        const endFormatted = (selesai === "Present") ? "Present" : this.formatDateForDisplay(selesai);
        const durasiText = durasi ? ` (${durasi})` : '';
        list.push(`${jabatan} at ${perusahaan} (${startFormatted} - ${endFormatted})${durasiText} - ${status}`);
      }
    });
    return list;
  }

  formatDateForDisplay(dateString) {
    if (!dateString || dateString === "Present") return dateString;
    const [year, month, day] = dateString.split('-');
    return `${day}-${month}-${year}`;
  }

  // ===== Validation =====
  validateForm() {
    let isValid = true;
    const errorMessages = [];
    let firstErrorField = null;

    this.clearAllErrors();

    const requiredFields = this.form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
      let fieldIsValid = true;
      let errorMsg = '';

      if (field.type === 'file') {
        if (!field.files || field.files.length === 0) {
          fieldIsValid = false;
          const label = field.previousElementSibling?.textContent?.replace('*', '').trim() || 'File';
          errorMsg = `${label} is required`;
          this.markFieldAsError(field, errorMsg);
        }
      } else if (!field.value || field.value.trim() === '') {
        fieldIsValid = false;
        const label = field.previousElementSibling?.textContent?.replace('*', '').trim() || 'This field';
        errorMsg = `${label} is required`;
        this.markFieldAsError(field, errorMsg);
      }

      if (!fieldIsValid) {
        isValid = false;
        errorMessages.push(errorMsg);
        if (!firstErrorField) firstErrorField = field;
      }
    });

    const emailField = document.getElementById('email');
    if (emailField.value && !this.isValidEmail(emailField.value)) {
      isValid = false;
      const msg = 'Please enter a valid email address';
      this.markFieldAsError(emailField, msg);
      if (!firstErrorField) firstErrorField = emailField;
      errorMessages.push(msg);
    }

    const phoneField = document.getElementById('nomorTelepon');
    if (phoneField.value && !this.isValidPhone(phoneField.value)) {
      isValid = false;
      const msg = 'Please enter a valid phone number (10-15 digits)';
      this.markFieldAsError(phoneField, msg);
      if (!firstErrorField) firstErrorField = phoneField;
      errorMessages.push(msg);
    }

    const eduEntries = document.querySelectorAll('.education-entry');
    if (eduEntries.length === 0) {
      isValid = false;
      errorMessages.push('At least one education entry is required');
    } else {
      eduEntries.forEach((entry, index) => {
        entry.querySelectorAll('input[required], select[required]').forEach(input => {
          if (!input.value || input.value.trim() === '') {
            isValid = false;
            const label = input.previousElementSibling?.textContent?.replace('*', '').trim() || 'Field';
            const msg = `${label} is required`;
            this.markFieldAsError(input, msg);
            errorMessages.push(`Education ${index + 1}: ${msg}`);
            if (!firstErrorField) firstErrorField = input;
          }
        });
      });
    }

    const expEntries = document.querySelectorAll('.experience-entry');
    if (expEntries.length === 0) {
      isValid = false;
      errorMessages.push('At least one work experience entry is required');
    } else {
      expEntries.forEach((entry, index) => {
        entry.querySelectorAll('input[required], select[required]').forEach(input => {
          if (!input.value || input.value.trim() === '') {
            isValid = false;
            const label = input.previousElementSibling?.textContent?.replace('*', '').trim() || 'Field';
            const msg = `${label} is required`;
            this.markFieldAsError(input, msg);
            errorMessages.push(`Experience ${index + 1}: ${msg}`);
            if (!firstErrorField) firstErrorField = input;
          }
        });
      });
    }

    if (!isValid) {
      const uniqueErrors = [...new Set(errorMessages)];
      const errorCount = uniqueErrors.length;
      const displayErrors = uniqueErrors.slice(0, 5);
      let statusMessage = `<strong>Found ${errorCount} error${errorCount > 1 ? 's' : ''}:</strong><br><ul style="margin: 8px 0; padding-left: 20px; text-align: left;">`;
      displayErrors.forEach(err => { statusMessage += `<li>${err}</li>`; });
      if (errorCount > 5) statusMessage += `<li><em>...and ${errorCount - 5} more error${errorCount - 5 > 1 ? 's' : ''}</em></li>`;
      statusMessage += '</ul>';
      this.showStatus(statusMessage, 'error');

      if (firstErrorField) {
        setTimeout(() => {
          firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstErrorField.focus();
        }, 100);
      }
    }
    return isValid;
  }

  markFieldAsError(field, message) {
    field.classList.add('error');
    let validationMessage = field.parentElement.querySelector('.validation-message');
    if (!validationMessage) {
      validationMessage = document.createElement('div');
      validationMessage.className = 'validation-message';
      field.parentElement.appendChild(validationMessage);
    }
    validationMessage.textContent = message;
    validationMessage.classList.add('error');
    validationMessage.style.display = 'block';
  }

  clearAllErrors() {
    this.form.querySelectorAll('.error').forEach(el => el.classList.remove('error', 'success'));
    this.form.querySelectorAll('.validation-message').forEach(msg => {
      msg.textContent = '';
      msg.className = 'validation-message';
      msg.style.display = 'none';
    });
  }

  isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
  isValidPhone(phone) { return /^[0-9+\-\s]{10,15}$/.test(phone); }

  // ===== Submit =====
  async handleSubmit(e) {
    e.preventDefault();
    this.status.style.display = "none";
    if (!this.validateForm()) return;

    const submitBtn = document.getElementById("submit-btn");
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    try {
      const experienceData = this.collectExperience();
      const educationData = this.collectEducation();
      if (educationData.length === 0) throw new Error("Please add at least one education entry with all required fields filled");
      if (experienceData.length === 0) throw new Error("Please add at least one work experience entry with all required fields filled");

      (document.getElementById("pendidikanTerakhir") as HTMLInputElement).value = educationData.join("; ");
      (document.getElementById("pengalamanKerja") as HTMLInputElement).value = experienceData.join(", ");

      const formData = new FormData(this.form);

      // Hanya izinkan field file tertentu
      const supportedFileFields = ['cv', 'photo', 'ktp', 'kk', 'ijazah'];
      Array.from(formData.keys()).forEach((key) => {
        const val = formData.get(key);
        if (val instanceof File && !supportedFileFields.includes(key)) formData.delete(key);
      });

      const response = await fetch(apiJoin('applicants'), {
        method: "POST",
        body: formData
      });

      // Handle response (tanpa console log di prod)
      const text = await response.text();
      let data = {};
      try { data = JSON.parse(text); } catch { /* biarkan fallback */ }

      if (!response.ok) {
        let msg = (data && (data.message || data.error)) || response.statusText;
        if (response.status === 400) {
          if (data.errors && Array.isArray(data.errors)) {
            msg = "Validation errors:<br>" + data.errors.map((err) => `• ${err}`).join("<br>");
          } else if (data.details) {
            msg = `Bad Request: ${msg}`;
          } else {
            msg = `Bad Request (400): ${msg}`;
          }
        } else if (response.status === 413) {
          msg = "File too large. Please reduce file sizes and try again.";
        } else if (response.status === 500) {
          msg = "Server error. Please try again later or contact support.";
        }
        throw new Error(msg);
      }

      if (data && data.success) {
        this.showStatus("Application submitted successfully! We'll contact you soon.", "success");
        this.clearAllErrors();
        this.form.reset();
        document.getElementById("education-container").innerHTML = '';
        document.getElementById("experience-container").innerHTML = '';
        this.educationCount = 0;
        this.experienceCount = 0;
        this.addEducation();
        this.addExperience();
        if (this.marker) { this.map.removeLayer(this.marker); this.marker = null; }
        const coordsDisplay = document.getElementById("location-coordinates-display");
        if (coordsDisplay) coordsDisplay.style.display = "none";
        this.status.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        const errDetail = (data && (data.message || data.error)) || "Submission failed";
        throw new Error(errDetail);
      }
    } catch (error) {
      let msg = (error && error.message) || "Submission failed";
      if (msg.includes("Failed to fetch")) {
        msg = "Cannot connect to server. Please check your connection or server availability.";
      }
      this.showStatus(`<strong>Submission Failed</strong><br>${msg}`, "error");
      this.status.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  // ===== Duration calc =====
  calculateDuration(entry) {
    if (!entry) return;
    const num = entry.getAttribute('data-entry-id');
    const startDateInput = entry.querySelector(`[name="tanggalMulaiKerja${num}"]`);
    const endDateInput = entry.querySelector(`[name="tanggalSelesaiKerja${num}"]`);
    const durationInput = entry.querySelector(`[name="durasiKerja${num}"]`);
    const statusSelect = entry.querySelector(`[name="statusKerja${num}"]`);
    if (!startDateInput || !durationInput) return;

    const startDate = startDateInput.value;
    let endDate = endDateInput?.value;
    if (statusSelect && statusSelect.value === 'Still Working') {
      const today = new Date();
      endDate = today.toISOString().split('T')[0];
    }
    if (!startDate) { durationInput.value = ''; return; }
    if (!endDate && statusSelect?.value !== 'Still Working') { durationInput.value = ''; return; }

    const start = new Date(startDate);
    const end = new Date(endDate);
    if (end < start) { durationInput.value = 'Invalid dates'; return; }

    let years = end.getFullYear() - start.getFullYear();
    let months = end.getMonth() - start.getMonth();
    let days = end.getDate() - start.getDate();
    if (days < 0) { months--; const prevMonth = new Date(end.getFullYear(), end.getMonth(), 0); days += prevMonth.getDate(); }
    if (months < 0) { years--; months += 12; }

    const parts = [];
    if (years > 0) parts.push(`${years} year${years > 1 ? 's' : ''}`);
    if (months > 0) parts.push(`${months} month${months > 1 ? 's' : ''}`);
    if (days > 0) parts.push(`${days} day${days > 1 ? 's' : ''}`);
    durationInput.value = parts.length > 0 ? parts.join(', ') : '0 days';
  }

  // ===== UI status =====
  showStatus(message, type) {
    this.status.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
      ${message}
    `;
    this.status.className = `status ${type}`;
    this.status.style.display = "flex";

    clearTimeout(this._statusTimer);
    if (type !== 'loading') {
      this._statusTimer = setTimeout(() => {
        this.status.style.display = "none";
      }, type === 'success' ? 8000 : 6000);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  window.jobApp = new JobApplicationManager();
});
</script>
