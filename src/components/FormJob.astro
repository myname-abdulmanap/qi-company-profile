---
const { slug } = Astro.props;

function formatSlugForDisplay(slug) {
  return slug
    .split('-')
    .map((word) => word.replace(/\d+/g, '').trim())
    .filter((word) => word.length > 0)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

const displayText = formatSlugForDisplay(slug);
---

<section class="job-application" id="job-application">
  <div class="job-application-container">
    <div class="section-title fade-in">
      <br />
      <br />
      <h2>Job Application</h2>
      <p>Join our team at Qualita Indonesia</p>
      <p>Fill out the form below to apply for available positions</p>
    </div>

    <form class="job-form fade-in" id="job-form" enctype="multipart/form-data" data-astro-reload>
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="form-section-title">üìã Basic Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="nama">Full Name *</label>
            <input type="text" id="nama" name="nama" placeholder="Enter your full name" required />
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" placeholder="Enter your email" required />
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="nomorTelepon">Phone Number *</label>
            <input
              type="tel"
              id="nomorTelepon"
              name="nomorTelepon"
              placeholder="e.g. +62812345678 or 08123456789"
              required
            />
          </div>
          <div class="form-group">
            <label for="posisi">Position *</label>
            <select id="posisi" name="posisi" required>
              <option value="">Select Position</option>
              <option value={slug} selected>{displayText}</option>
            </select>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="alamat">Address *</label>
          <textarea id="alamat" name="alamat" placeholder="Enter your complete address" required
          ></textarea>
        </div>

        <div class="form-group">
          <label for="tanggalLahir">Date of Birth *</label>
          <input type="date" id="tanggalLahir" name="tanggalLahir" required />
        </div>
      </div>

      <!-- Education -->
      <div class="form-section">
        <h3 class="form-section-title">üéì Education</h3>

        <!-- Education 1 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Degree *</label>
              <input
                type="text"
                name="pendidikan_gelar_0"
                placeholder="e.g. S1, D3, SMA"
                required
              />
            </div>
            <div class="form-group">
              <label>Institution *</label>
              <input
                type="text"
                name="pendidikan_institusi_0"
                placeholder="University/School name"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label>Graduation Year *</label>
            <input
              type="number"
              name="pendidikan_tahun_0"
              placeholder="e.g. 2023"
              min="1980"
              max="2030"
              required
            />
          </div>
          <div class="form-group">
            <label>Major/Field of Study</label>
            <input type="text" name="pendidikan_jurusan_0" placeholder="e.g. Computer Science" />
          </div>
        </div>

        <!-- Education 2 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Degree 2 <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pendidikan_gelar_1"
                placeholder="e.g. S1, D3, SMA"
              />
            </div>
            <div class="form-group">
              <label>Institution <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pendidikan_institusi_1"
                placeholder="University/School name"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Graduation Year <span class="optional">(Optional)</span></label>
            <input
              type="number"
              name="pendidikan_tahun_1"
              placeholder="e.g. 2023"
              min="1980"
              max="2030"
            />
          </div>
          <div class="form-group">
            <label>Major/Field of Study <span class="optional">(Optional)</span></label>
            <input type="text" name="pendidikan_jurusan_1" placeholder="e.g. Computer Science" />
          </div>
        </div>

        <!-- Education 3 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Degree 3 <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pendidikan_gelar_2"
                placeholder="e.g. S1, D3, SMA"
              />
            </div>
            <div class="form-group">
              <label>Institution <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pendidikan_institusi_2"
                placeholder="University/School name"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Graduation Year <span class="optional">(Optional)</span></label>
            <input
              type="number"
              name="pendidikan_tahun_2"
              placeholder="e.g. 2023"
              min="1980"
              max="2030"
            />
          </div>
          <div class="form-group">
            <label>Major/Field of Study <span class="optional">(Optional)</span></label>
            <input type="text" name="pendidikan_jurusan_2" placeholder="e.g. Computer Science" />
          </div>
        </div>
      </div>

      <!-- Work Experience -->
      <div class="form-section">
        <h3 class="form-section-title">üíº Work Experience</h3>

        <!-- Experience 1 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Job Title *</label>
              <input
                type="text"
                name="pengalaman_jabatan_0"
                placeholder="e.g. Software Developer"
                required
              />
            </div>
            <div class="form-group">
              <label>Company *</label>
              <input
                type="text"
                name="pengalaman_perusahaan_0"
                placeholder="Company name"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label>Duration *</label>
            <input
              type="text"
              name="pengalaman_durasi_0"
              placeholder="e.g. 2020-2023 or 3 years"
              required
            />
          </div>
        </div>

        <!-- Experience 2 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Job Title 2 <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pengalaman_jabatan_1"
                placeholder="e.g. Software Developer"
              />
            </div>
            <div class="form-group">
              <label>Company <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pengalaman_perusahaan_1"
                placeholder="Company name"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Duration <span class="optional">(Optional)</span></label>
            <input
              type="text"
              name="pengalaman_durasi_1"
              placeholder="e.g. 2020-2023 or 3 years"
            />
          </div>
        </div>

        <!-- Experience 3 -->
        <div class="static-item">
          <div class="form-grid">
            <div class="form-group">
              <label>Job Title 3 <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pengalaman_jabatan_2"
                placeholder="e.g. Software Developer"
              />
            </div>
            <div class="form-group">
              <label>Company <span class="optional">(Optional)</span></label>
              <input
                type="text"
                name="pengalaman_perusahaan_2"
                placeholder="Company name"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Duration <span class="optional">(Optional)</span></label>
            <input
              type="text"
              name="pengalaman_durasi_2"
              placeholder="e.g. 2020-2023 or 3 years"
            />
          </div>
        </div>
      </div>

      <!-- Skills -->
      <div class="form-section">
        <h3 class="form-section-title">üõ†Ô∏è Skills</h3>
        <div class="form-group">
          <input
            type="text"
            name="skill_0"
            placeholder="e.g. JavaScript, Python, Leadership"
            required
          />
        </div>
      </div>

      <!-- Certifications -->
      <div class="form-section">
        <h3 class="form-section-title">üèÖ Certifications</h3>
        <div class="form-group">
          <input
            type="text"
            name="sertifikasi_0"
            placeholder="e.g. AWS Certified, Google Analytics"
          />
        </div>
      </div>

      <!-- Languages -->
      <div class="form-section">
        <h3 class="form-section-title">üåê Languages</h3>
        <div class="form-group">
          <input
            type="text"
            name="bahasa_0"
            placeholder="e.g. English (Fluent), Mandarin (Basic)"
          />
        </div>
      </div>

      <!-- Additional Information -->
      <div class="form-section">
        <h3 class="form-section-title">üîó Additional Information</h3>
        <div class="form-group">
          <label for="linkedin">LinkedIn/Portfolio URL</label>
          <input
            type="url"
            id="linkedin"
            name="linkedin"
            placeholder="https://linkedin.com/in/yourprofile"
          />
        </div>
      </div>

      <!-- CV Upload -->
      <div class="form-section">
        <h3 class="form-section-title">üìÑ CV/Resume</h3>
        <div class="form-group">
          <label for="cv">Upload CV/Resume *</label>
          <div class="file-upload-container">
            <input
              type="file"
              id="cv"
              name="cv"
              accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
              class="file-input"
              required
            />
            <label for="cv" class="file-label">
              <span class="file-icon">üìÑ</span>
              <span class="file-text">Choose CV file (PDF, DOC, DOCX, JPG, PNG)</span>
            </label>
            <div class="file-info" id="file-info"></div>
          </div>
          <small class="form-note"
            >Maximum file size: 2MB. Supported formats: PDF, DOC, DOCX, JPG, PNG</small
          >
        </div>
      </div>

      <!-- Hidden fields for EmailJS -->
      <input type="hidden" name="applicant_name" id="applicant_name" />
      <input type="hidden" name="applicant_email" id="applicant_email" />
      <input type="hidden" name="phone_number" id="phone_number" />
      <input type="hidden" name="position" id="position" />
      <input type="hidden" name="address" id="address" />
      <input type="hidden" name="birth_date" id="birth_date" />
      <input type="hidden" name="education_data" id="education_data" />
      <input type="hidden" name="experience_data" id="experience_data" />
      <input type="hidden" name="skills_data" id="skills_data" />
      <input type="hidden" name="certifications_data" id="certifications_data" />
      <input type="hidden" name="languages_data" id="languages_data" />
      <input type="hidden" name="cv_url" id="cv_url" />
      <input type="hidden" name="cv_filename" id="cv_filename" />

      <!-- reCAPTCHA -->
      <div class="form-group">
        <div class="g-recaptcha" data-sitekey="6LcSPkYrAAAAAA3TN5ptXfbY_nsfOOCCPXjMMESG"></div>
      </div>
      <p class="captcha-warning">
        * Jika captcha tidak muncul, silakan refresh halaman terlebih dahulu.
      </p>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn primary" id="submit-btn">Submit Application</button>
      </div>

      <div class="form-actions">
        <a href={`/careers/${slug}`} class="btn secondary">Back to Detail</a>
      </div>

      <!-- Status and Progress -->
      <div class="status" id="status"></div>
      <div class="submission-progress" id="submission-progress" style="display: none;">
        <div class="progress-item" id="api-progress">
          <span class="progress-icon">‚è≥</span>
          <span class="progress-text">Submitting to database and uploading CV...</span>
        </div>
        <div class="progress-item" id="email-progress">
          <span class="progress-icon">‚è≥</span>
          <span class="progress-text">Sending email notification...</span>
        </div>
      </div>
    </form>
  </div>
</section>

<!-- Scripts -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
  // Parse dynamic fields for backend
  function parseDynamicFields() {
    const formData = new FormData(document.getElementById('job-form'));

    // Parse education (3 forms) - format: Gelar - Institusi - TahunLulus
    const pendidikan = [];
    for (let i = 0; i < 3; i++) {
      const gelar = formData.get(`pendidikan_gelar_${i}`);
      const institusi = formData.get(`pendidikan_institusi_${i}`);
      const tahun = formData.get(`pendidikan_tahun_${i}`);

      // Hanya tambahkan jika gelar, institusi, dan tahun tersedia
      if (gelar && institusi && tahun) {
        pendidikan.push(`${gelar} - ${institusi} - ${tahun}`);
      }
    }

    // Parse experience (3 forms) - format: Jabatan - Perusahaan - Durasi
    const pengalaman = [];
    for (let i = 0; i < 3; i++) {
      const jabatan = formData.get(`pengalaman_jabatan_${i}`);
      const perusahaan = formData.get(`pengalaman_perusahaan_${i}`);
      const durasi = formData.get(`pengalaman_durasi_${i}`);

      // Hanya tambahkan jika jabatan, perusahaan, dan durasi tersedia
      if (jabatan && perusahaan && durasi) {
        pengalaman.push(`${jabatan} - ${perusahaan} - ${durasi}`);
      }
    }

    // Parse skills (single field) - format: comma separated
    const skills = [];
    const skill = formData.get('skill_0');
    if (skill && skill.trim()) {
      // Split by comma and clean up
      const skillList = skill.split(',').map(s => s.trim()).filter(s => s.length > 0);
      skills.push(...skillList);
    }

    // Parse certifications (single field) - format: comma separated
    const sertifikasi = [];
    const cert = formData.get('sertifikasi_0');
    if (cert && cert.trim()) {
      // Split by comma and clean up
      const certList = cert.split(',').map(s => s.trim()).filter(s => s.length > 0);
      sertifikasi.push(...certList);
    }

    // Parse languages (single field) - format: comma separated
    const bahasa = [];
    const lang = formData.get('bahasa_0');
    if (lang && lang.trim()) {
      // Split by comma and clean up
      const langList = lang.split(',').map(s => s.trim()).filter(s => s.length > 0);
      bahasa.push(...langList);
    }

    return {
      pendidikan: pendidikan.join(';'),
      pengalaman: pengalaman.join(';'),
      skills: skills.join(', '),
      sertifikasi: sertifikasi.join(', '),
      bahasa: bahasa.join(', '),
    };
  }

  // Convert date format from YYYY-MM-DD to DD-MM-YYYY
  function formatDateForBackend(dateString) {
    if (!dateString) return '';

    // Input format: YYYY-MM-DD (from HTML date input)
    // Output format: DD-MM-YYYY (expected by backend)
    const parts = dateString.split('-');
    if (parts.length === 3) {
      const [year, month, day] = parts;
      return `${day}-${month}-${year}`;
    }
    return dateString;
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Initialize EmailJS
    emailjs.init('4-iOyCns2viav_IW_');

    const form = document.getElementById('job-form');
    const submitBtn = document.getElementById('submit-btn');
    const status = document.getElementById('status');
    const fileInput = document.getElementById('cv');
    const fileInfo = document.getElementById('file-info');
    const progressContainer = document.getElementById('submission-progress');
    const apiProgress = document.getElementById('api-progress');
    const emailProgress = document.getElementById('email-progress');

    if (!form || !submitBtn || !status) {
      return;
    }

    const getApiBaseUrl = () => {
      return '/api';
    };

    // File upload handling
    fileInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024) {
          showStatus('File size must be less than 2MB', 'error');
          fileInput.value = '';
          fileInfo.textContent = '';
          return;
        }

        const allowedTypes = [
          'application/pdf',
          'application/msword',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'image/jpeg',
          'image/jpg',
          'image/png',
        ];
        if (!allowedTypes.includes(file.type)) {
          showStatus(
            'Invalid file type. Please upload PDF, DOC, DOCX, JPG, or PNG files only.',
            'error',
          );
          fileInput.value = '';
          fileInfo.textContent = '';
          return;
        }

        fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        fileInfo.style.color = '#48bb78';
      } else {
        fileInfo.textContent = '';
      }
    });

    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';

      setTimeout(() => {
        status.style.display = 'none';
      }, 8000);
    }

    function updateProgress(element, icon, text, status) {
      const iconSpan = element.querySelector('.progress-icon');
      const textSpan = element.querySelector('.progress-text');

      iconSpan.textContent = icon;
      textSpan.textContent = text;
      element.className = `progress-item ${status}`;
    }

    function setLoading(isLoading) {
      if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span>Submitting...';
        progressContainer.style.display = 'block';
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Application';
        progressContainer.style.display = 'none';
      }
    }

    // Enhanced form validation
    function validateForm() {
      const nama = document.getElementById('nama').value.trim();
      const email = document.getElementById('email').value.trim();
      const nomorTelepon = document.getElementById('nomorTelepon').value.trim();
      const posisi = document.getElementById('posisi').value;
      const alamat = document.getElementById('alamat').value.trim();
      const tanggalLahir = document.getElementById('tanggalLahir').value;
      const cv = document.getElementById('cv').files[0];

      // Check required fields
      if (!nama || !email || !nomorTelepon || !posisi || !alamat || !tanggalLahir || !cv) {
        showStatus(
          'Please fill in all required fields (marked with *) and upload your CV.',
          'error',
        );
        return false;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showStatus('Please enter a valid email address.', 'error');
        return false;
      }

      // Validate phone number format (Indonesian)
      const phoneRegex = /^(\+62|62|0)[0-9]{9,13}$/;
      const cleanPhone = nomorTelepon.replace(/\s|-/g, '');
      if (!phoneRegex.test(cleanPhone)) {
        showStatus('Please enter a valid Indonesian phone number.', 'error');
        return false;
      }

      // Validate education (at least first one must be complete)
      const formData = new FormData(document.getElementById('job-form'));
      const gelar0 = formData.get('pendidikan_gelar_0');
      const institusi0 = formData.get('pendidikan_institusi_0');
      const tahun0 = formData.get('pendidikan_tahun_0');

      if (!gelar0 || !institusi0 || !tahun0) {
        showStatus('Please complete at least the first education entry (degree, institution, and year).', 'error');
        return false;
      }

      // Validate experience (at least first one must be complete)
      const jabatan0 = formData.get('pengalaman_jabatan_0');
      const perusahaan0 = formData.get('pengalaman_perusahaan_0');
      const durasi0 = formData.get('pengalaman_durasi_0');

      if (!jabatan0 || !perusahaan0 || !durasi0) {
        showStatus('Please complete at least the first work experience entry (job title, company, and duration).', 'error');
        return false;
      }

      // Validate skills
      const skill0 = formData.get('skill_0');
      if (!skill0 || !skill0.trim()) {
        showStatus('Please enter at least one skill.', 'error');
        return false;
      }

      // Validate LinkedIn URL if provided
      const linkedin = formData.get('linkedin');
      if (linkedin && linkedin.trim()) {
        const urlRegex = /^https?:\/\/(www\.)?(linkedin\.com|[\w\-]+\.\w+)/;
        if (!urlRegex.test(linkedin.trim())) {
          showStatus('Please enter a valid LinkedIn/Portfolio URL (must start with http:// or https://).', 'error');
          return false;
        }
      }

      // Validate reCAPTCHA
      if (typeof grecaptcha !== 'undefined') {
        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
          showStatus('Please complete the reCAPTCHA verification.', 'error');
          return false;
        }
      }

      return true;
    }

    // Enhanced hidden fields sync for EmailJS
    function syncHiddenFields(apiResponseData = null) {
      const parsedData = parseDynamicFields();
      const formData = new FormData(document.getElementById('job-form'));

      // Sync all required fields
      document.getElementById('applicant_name').value = formData.get('nama') || '';
      document.getElementById('applicant_email').value = formData.get('email') || '';
      document.getElementById('phone_number').value = formData.get('nomorTelepon') || '';
      document.getElementById('position').value = formData.get('posisi') || '';
      document.getElementById('address').value = formData.get('alamat') || '';

      // Format date for email
      const tanggalLahir = formData.get('tanggalLahir');
      document.getElementById('birth_date').value = formatDateForBackend(tanggalLahir);

      // Sync parsed data
      document.getElementById('education_data').value = parsedData.pendidikan || 'Not provided';
      document.getElementById('experience_data').value = parsedData.pengalaman || 'Not provided';
      document.getElementById('skills_data').value = parsedData.skills || 'Not provided';
      document.getElementById('certifications_data').value = parsedData.sertifikasi || 'Not provided';
      document.getElementById('languages_data').value = parsedData.bahasa || 'Not provided';

      // LinkedIn - get from the linkedin field directly
      const linkedinField = document.getElementById('linkedin');
      const linkedinValue = linkedinField ? linkedinField.value : '';

      // CV information
      if (apiResponseData && apiResponseData.cvUrl) {
        document.getElementById('cv_url').value = apiResponseData.cvUrl;
        document.getElementById('cv_filename').value = apiResponseData.cvFilename || '';
      } else {
        document.getElementById('cv_url').value = 'CV uploaded via API (URL not provided)';
        document.getElementById('cv_filename').value =
          document.getElementById('cv').files[0]?.name || 'CV file';
      }
    }

    // Enhanced form data preparation for backend
    function prepareFormDataForBackend() {
      const formData = new FormData(form);
      const parsedData = parseDynamicFields();

      // Create new FormData with correct field names
      const backendFormData = new FormData();

      // Basic information fields - exact field names from backend
      backendFormData.set('nama', formData.get('nama') || '');
      backendFormData.set('email', formData.get('email') || '');
      backendFormData.set('alamat', formData.get('alamat') || '');
      backendFormData.set('nomorTelepon', formData.get('nomorTelepon') || '');
      backendFormData.set('posisi', formData.get('posisi') || '');

      // Format tanggal lahir from YYYY-MM-DD to DD-MM-YYYY
      const tanggalLahir = formData.get('tanggalLahir');
      backendFormData.set('tanggalLahir', formatDateForBackend(tanggalLahir));

      // Parsed data fields - exact field names from backend
      backendFormData.set('pendidikanTerakhir', parsedData.pendidikan);
      backendFormData.set('pengalamanKerja', parsedData.pengalaman);
      backendFormData.set('skill', parsedData.skills);
      backendFormData.set('sertifikasi', parsedData.sertifikasi);
      backendFormData.set('bahasa', parsedData.bahasa);
      backendFormData.set('linkedin', formData.get('linkedin') || '');

      // Add CV file if exists
      const cvFile = formData.get('cv');
      if (cvFile && cvFile.size > 0) {
        backendFormData.set('cv', cvFile);
      }

      return backendFormData;
    }

    // Debug function to log data before submission
    function debugFormData() {
      const formData = prepareFormDataForBackend();

      console.log('=== FORM DATA DEBUG ===');
      for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
          console.log(`${key}: [File] ${value.name} (${value.size} bytes)`);
        } else {
          console.log(`${key}: ${value}`);
        }
      }
      console.log('=== END DEBUG ===');

      // Also log the expected JSON structure
      const jsonData = {
        nama: formData.get('nama'),
        email: formData.get('email'),
        alamat: formData.get('alamat'),
        nomorTelepon: formData.get('nomorTelepon'),
        posisi: formData.get('posisi'),
        tanggalLahir: formData.get('tanggalLahir'),
        pendidikanTerakhir: formData.get('pendidikanTerakhir'),
        pengalamanKerja: formData.get('pengalamanKerja'),
        skill: formData.get('skill'),
        sertifikasi: formData.get('sertifikasi'),
        bahasa: formData.get('bahasa'),
        linkedin: formData.get('linkedin')
      };

      console.log('=== EXPECTED JSON STRUCTURE ===');
      console.log(JSON.stringify(jsonData, null, 2));
      console.log('=== END JSON DEBUG ===');
    }

    // Network connectivity and error handling
    function checkConnectivity() {
      return navigator.onLine;
    }

    function handleNetworkError(error) {
      if (!checkConnectivity()) {
        return 'No internet connection. Please check your network and try again.';
      }
      if (error.name === 'AbortError') {
        return 'Request timeout. Please try again.';
      }
      if (error.code === 'ECONNREFUSED' || error.message.includes('ECONNREFUSED')) {
        return 'Server is not responding. Please try again later or contact support.';
      }
      if (error.message.includes('Failed to fetch')) {
        return 'Unable to connect to server. Please check your connection and try again.';
      }
      return error.message || 'Network error occurred. Please try again.';
    }

    // Submit to API with enhanced error handling
    async function submitToAPI() {
      updateProgress(apiProgress, '‚è≥', 'Submitting and uploading CV...', 'processing');

      try {
        const formData = prepareFormDataForBackend();

        // Debug: Log form data before submission (remove in production)
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
          debugFormData();
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);

        const baseUrl = getApiBaseUrl();
        const endpoint = `${baseUrl}/api/v1/applicants/submit`;

        const response = await fetch(endpoint, {
          method: 'POST',
          body: formData,
          signal: controller.signal,
          // Don't set Content-Type header - let browser set it for FormData
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;

          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.error || errorJson.message || errorMessage;

            // If validation errors exist, show them
            if (errorJson.details && Array.isArray(errorJson.details)) {
              const validationErrors = errorJson.details.map(err => err.message).join('; ');
              errorMessage += ` - ${validationErrors}`;
            }
          } catch (e) {
            // If response is not JSON, use the text
            if (errorText) {
              errorMessage = errorText;
            }
          }

          throw new Error(errorMessage);
        }

        const contentType = response.headers.get('content-type');
        let result;

        if (contentType && contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          result = { success: response.ok, message: text };
        }

        if (result.success) {
          updateProgress(
            apiProgress,
            '‚úÖ',
            'Saved to database and CV uploaded successfully',
            'success',
          );

          return {
            success: true,
            message: result.message,
            data: {
              cvUrl: result.data?.cvLink || result.cvUrl || result.cv_url || '',
              cvFilename: result.data?.cvFileName || result.cvFilename || result.cv_filename ||
                         document.getElementById('cv').files[0]?.name || '',
            },
          };
        } else {
          throw new Error(result.error || result.message || 'API submission failed');
        }
      } catch (error) {
        updateProgress(apiProgress, '‚ùå', 'Database submission failed', 'error');
        const errorMessage = handleNetworkError(error);
        console.error('API submission error:', error);
        return { success: false, message: errorMessage };
      }
    }

    // Submit to EmailJS
    async function submitToEmailJS(apiResponseData = null) {
      updateProgress(emailProgress, '‚è≥', 'Sending email notification...', 'processing');

      try {
        syncHiddenFields(apiResponseData);

        const tempForm = document.createElement('form');
        const fieldsData = {
          applicant_name: document.getElementById('applicant_name').value,
          applicant_email: document.getElementById('applicant_email').value,
          phone_number: document.getElementById('phone_number').value,
          position: document.getElementById('position').value,
          address: document.getElementById('address').value,
          birth_date: document.getElementById('birth_date').value,
          education_data: document.getElementById('education_data').value,
          experience_data: document.getElementById('experience_data').value,
          skills_data: document.getElementById('skills_data').value,
          certifications_data: document.getElementById('certifications_data').value,
          languages_data: document.getElementById('languages_data').value,
          cv_url: document.getElementById('cv_url').value,
          cv_filename: document.getElementById('cv_filename').value,
          linkedin: document.getElementById('linkedin').value || 'Not provided',
          application_date: new Date().toLocaleDateString('id-ID'),
          submission_method: 'Website Form',
        };

        Object.keys(fieldsData).forEach((fieldName) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = fieldName;
          input.value = fieldsData[fieldName] || '';
          tempForm.appendChild(input);
        });

        const response = await emailjs.sendForm('service_drhscig', 'template_sc48jkv', tempForm);

        updateProgress(emailProgress, '‚úÖ', 'Email notification sent', 'success');
        return { success: true, message: 'Email sent successfully' };
      } catch (error) {
        updateProgress(emailProgress, '‚ùå', 'Email notification failed', 'error');
        return {
          success: false,
          message: `Failed to send email notification: ${error.text || error.message}`,
        };
      }
    }

    // Main submission function
    async function submitApplication() {
      if (!validateForm()) return;
      if (!checkConnectivity()) {
        showStatus('No internet connection. Please check your network and try again.', 'error');
        return;
      }

      setLoading(true);

      try {
        const apiResult = await submitToAPI();

        if (apiResult.success) {
          const emailResult = await submitToEmailJS(apiResult.data);

          let finalMessage = '';
          let finalStatus = '';

          if (emailResult.success) {
            finalMessage = "Application submitted successfully! We'll contact you soon.";
            finalStatus = 'success';
          } else {
            finalMessage = 'Application submitted successfully! Your application has been saved.';
            finalStatus = 'success';
          }

          form.reset();
          fileInfo.textContent = '';
          if (typeof grecaptcha !== 'undefined') {
            grecaptcha.reset();
          }

          showStatus(finalMessage, finalStatus);
        } else {
          showStatus(
            apiResult.message || 'Application submission failed. Please try again.',
            'error',
          );
        }
      } catch (error) {
        showStatus('An unexpected error occurred. Please try again.', 'error');
        console.error('Submission error:', error);
      } finally {
        setLoading(false);
      }
    }

    // Event listener for form submit
    submitBtn.addEventListener('click', function (e) {
      e.preventDefault();
      submitApplication();
    });

    // Real-time validation feedback
    const inputs = document.querySelectorAll(
      '#job-form input, #job-form textarea, #job-form select',
    );
    inputs.forEach((input) => {
      input.addEventListener('focus', function () {
        this.parentElement.style.transform = 'scale(1.01)';
        this.parentElement.style.transition = 'transform 0.2s ease';
      });

      input.addEventListener('blur', function () {
        this.parentElement.style.transform = 'scale(1)';
      });

      input.addEventListener('input', function () {
        if (this.hasAttribute('required') && this.value.trim() === '') {
          this.style.borderColor = '#f56565';
        } else if (this.type === 'email' && this.value.trim() !== '') {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          this.style.borderColor = emailRegex.test(this.value) ? '#48bb78' : '#f56565';
        } else if (this.type === 'tel' && this.value.trim() !== '') {
          const phoneRegex = /^(\+62|62|0)[0-9]{9,13}$/;
          this.style.borderColor = phoneRegex.test(this.value.replace(/\s|-/g, ''))
            ? '#48bb78'
            : '#f56565';
        } else if (this.value.trim() !== '') {
          this.style.borderColor = '#48bb78';
        } else {
          this.style.borderColor = '#e2e8f0';
        }
      });
    });

    // Network status monitoring
    window.addEventListener('online', function () {
      showStatus('Connection restored!', 'success');
    });

    window.addEventListener('offline', function () {
      showStatus('No internet connection. Please check your network.', 'error');
    });
  });

  // For compatibility with view transitions
  document.addEventListener('astro:page-load', function () {
    if (typeof emailjs !== 'undefined') {
      emailjs.init('4-iOyCns2viav_IW_');
    }
  });
</script>

<style>
  .job-application {
    padding: 8rem 1rem;
    background: var(--color-contact);
  }

  .job-application-container {
    max-width: 800px;
    margin: 0 auto;
  }

  .job-form {
    margin-top: 4rem;
  }

  /* Form sections */
  .form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .form-section-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Static sections (replacing dynamic sections) */
  .static-item {
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
  }

  .static-item:last-child {
    margin-bottom: 0;
  }

  /* Optional label styling */
  .optional {
    font-size: 0.85rem;
    color: #6b7280;
    font-weight: 400;
    font-style: italic;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-color);
    font-weight: 500;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 1rem;
    color: var(--text-color);
    transition: border-color 0.3s ease;
    background: white;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary);
  }

  .form-group textarea {
    height: 100px;
    resize: vertical;
  }

  .form-group select {
    cursor: pointer;
  }

  /* File upload styling */
  .file-upload-container {
    position: relative;
  }

  .file-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .file-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    border: 2px dashed #e2e8f0;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
  }

  .file-label:hover {
    border-color: var(--primary);
    background: #f0f8ff;
  }

  .file-icon {
    font-size: 1.5rem;
  }

  .file-text {
    color: var(--text-color);
    font-size: 0.95rem;
  }

  .file-info {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #666;
  }

  .form-note {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #666;
  }

  /* Submission progress */
  .submission-progress {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
  }

  .progress-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
  }

  .progress-item:last-child {
    margin-bottom: 0;
  }

  .progress-item.processing {
    background: #fff3cd;
    color: #856404;
  }

  .progress-item.success {
    background: #d4edda;
    color: #155724;
  }

  .progress-item.error {
    background: #f8d7da;
    color: #721c24;
  }

  .progress-icon {
    font-size: 1rem;
    min-width: 20px;
  }

  .progress-text {
    font-size: 0.9rem;
    font-weight: 500;
  }

  /* Form actions */
  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
  }

  .btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn.primary {
    background: var(--primary);
    color: white;
  }

  .btn.primary:hover {
    background: var(--primary-dark, #2563eb);
    transform: translateY(-2px);
  }

  .btn.secondary {
    background: #6b7280;
    color: white;
  }

  .btn.secondary:hover {
    background: #4b5563;
    transform: translateY(-2px);
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Status messages */
  .status {
    margin-top: 1.5rem;
    padding: 1rem;
    border-radius: 0.5rem;
    text-align: center;
    font-weight: 500;
    display: none;
  }

  .status.success {
    background: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
  }

  .status.error {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
  }

  .status.warning {
    background: #fff3cd;
    color: #856404;
    border: 2px solid #ffeaa7;
  }

  /* Loading spinner */
  .loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .job-application {
      padding: 4rem 1rem;
    }

    .form-actions {
      flex-direction: column;
      align-items: center;
    }

    .btn {
      width: 100%;
      max-width: 300px;
    }

    .static-item {
      padding: 0.75rem;
    }
  }

  @media (max-width: 480px) {
    .job-application {
      padding: 2rem 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      font-size: 0.9rem;
    }
  }

  .captcha-warning {
    margin-top: 1rem;
    color: #d9534f;
    font-size: 0.9rem;
  }
</style>
