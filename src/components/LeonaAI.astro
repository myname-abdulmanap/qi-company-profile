---
/**
 * LeonaAI.astro
 * Widget chatbot knowledge assistant - Leona AI
 * Uses global CSS variables for consistent theming
 */
---

<!-- Floating Chat Button -->
<div id="leona-ai-widget">
  <!-- Floating help text -->
  <div class="leona-help-bubble">
    <span>Butuh bantuan?</span>
  </div>

  <button
    id="leona-toggle-btn"
    class="leona-fab"
    aria-label="Open Leona AI Chat"
  >
    <span class="leona-pulse-ring"></span>
    <img
      src="/assets/img/leona.png"
      alt="Leona AI"
      class="leona-fab-img chat-icon"
    />
    <svg
      class="close-icon hidden"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <!-- Chat Popup -->
  <div id="leona-popup" class="leona-popup hidden">
    <!-- Header -->
    <div class="leona-popup-header">
      <div class="leona-avatar">
        <img src="/assets/img/leona.png" alt="Leona AI" />
      </div>
      <div class="leona-header-info">
        <h4>Leona AI</h4>
        <span class="leona-status">
          <span class="status-dot"></span>
          Online
        </span>
      </div>
      <button
        id="leona-close-btn"
        class="leona-close-btn"
        aria-label="Close chat"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Messages Body -->
    <div class="leona-popup-body" id="leona-messages">
      <!-- Welcome Message -->
      <div class="leona-message leona-bot">
        <div class="leona-message-avatar">
          <img src="/assets/img/leona.png" alt="Leona" />
        </div>
        <div class="leona-message-content">
          <p>
            Halo! ðŸ‘‹ Saya <strong>Leona AI</strong>, asisten knowledge PT.
            Qualita Indonesia.
          </p>
          <p>Ada yang bisa saya bantu?</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="leona-quick-actions">
        <button
          class="leona-quick-btn"
          data-message="Apa saja produk Qualita Indonesia?">Produk</button
        >
        <button
          class="leona-quick-btn"
          data-message="Bagaimana cara menghubungi Qualita Indonesia?"
          >Kontak</button
        >
        <button
          class="leona-quick-btn"
          data-message="Apa saja layanan yang ditawarkan?">Layanan</button
        >
        <button
          class="leona-quick-btn"
          data-message="Apakah ada lowongan pekerjaan?">Karir</button
        >
      </div>
    </div>

    <!-- Footer Input -->
    <div class="leona-popup-footer">
      <form id="leona-form" class="leona-input-form">
        <input
          type="text"
          id="leona-input"
          class="leona-input"
          placeholder="Ketik pesan..."
          autocomplete="off"
        />
        <button type="submit" class="leona-send-btn" aria-label="Send message">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>

<style is:global>
  /* ================================
     LEONA AI WIDGET
     Uses CSS vars from global.css
     ================================ */

  #leona-ai-widget {
    position: fixed;
    bottom: 12px;
    right: 24px;
    z-index: 9999;
    font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
  }

  /* Floating Help Bubble */
  .leona-help-bubble {
    background: var(--color-card, #fff);
    color: var(--text-color, #333);
    padding: 8px 14px;
    border-radius: 18px 18px 4px 18px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    animation:
      helpPop 0.4s ease,
      helpFloat 3s ease-in-out 0.4s infinite;
    transform-origin: bottom right;
  }

  @keyframes helpPop {
    0% {
      opacity: 0;
      transform: scale(0.8) translateY(10px);
    }
    100% {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes helpFloat {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-4px);
    }
  }

  .leona-help-bubble span {
    display: inline-block;
    animation: textWave 2s ease-in-out infinite;
  }

  @keyframes textWave {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  /* Floating Button */
  .leona-fab {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: none;
    transition: all 0.4s ease;
    color: #fff;
    width: 56px;
    height: 56px;
    overflow: visible;
    position: relative;
  }

  .leona-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
  }

  .leona-fab:hover .leona-fab-img {
    animation-play-state: paused;
  }

  /* Pulse ring behind avatar */
  .leona-pulse-ring {
    position: absolute;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.2);
    animation: leonaPulseRing 2.5s ease-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes leonaPulseRing {
    0% {
      transform: scale(0.85);
      opacity: 0.6;
    }
    70% {
      transform: scale(1.4);
      opacity: 0;
    }
    100% {
      transform: scale(1.4);
      opacity: 0;
    }
  }

  .leona-fab-img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    pointer-events: none;
    position: relative;
    top: 0px;
    z-index: 1;
    animation:
      leonaBounce 2.5s ease-in-out infinite,
      leonaWave 4s ease-in-out 1s infinite;
    transform-origin: center bottom;
  }

  @keyframes leonaBounce {
    0%,
    100% {
      transform: translateY(0);
    }
    15% {
      transform: translateY(-6px);
    }
    30% {
      transform: translateY(0);
    }
    45% {
      transform: translateY(-3px);
    }
    60% {
      transform: translateY(0);
    }
  }

  @keyframes leonaWave {
    0%,
    100% {
      transform: rotate(0deg);
    }
    10% {
      transform: rotate(8deg);
    }
    20% {
      transform: rotate(-6deg);
    }
    30% {
      transform: rotate(4deg);
    }
    40% {
      transform: rotate(0deg);
    }
  }

  .leona-fab .close-icon {
    width: 22px;
    height: 22px;
    margin: 7px;
  }

  .hidden {
    display: none !important;
  }

  /* Popup */
  .leona-popup {
    position: absolute;
    bottom: 65px;
    right: 0;
    width: 360px;
    max-width: calc(100vw - 48px);
    height: 480px;
    max-height: calc(100vh - 120px);
    background: var(--color-card, #fff);
    border-radius: 16px;
    box-shadow:
      0 20px 60px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes popIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Header */
  .leona-popup-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 100%);
    color: #fff;
  }

  .leona-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    flex-shrink: 0;
    overflow: hidden;
  }

  .leona-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    image-rendering: -webkit-optimize-contrast;
  }

  .leona-header-info {
    flex: 1;
  }

  .leona-header-info h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #fff;
    letter-spacing: 0.2px;
  }

  .leona-status {
    font-size: 11px;
    opacity: 0.85;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 2px;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    background: #4ade80;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
      box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.5);
    }
    50% {
      opacity: 0.8;
      box-shadow: 0 0 0 5px rgba(74, 222, 128, 0);
    }
  }

  .leona-close-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.12);
    border: none;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.25s ease;
  }

  .leona-close-btn:hover {
    background: rgba(255, 255, 255, 0.22);
    transform: rotate(90deg);
  }

  .leona-close-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Messages Body */
  .leona-popup-body {
    flex: 1;
    padding: 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: var(--bg-main, #f5f7fa);
  }

  .leona-popup-body::-webkit-scrollbar {
    width: 5px;
  }

  .leona-popup-body::-webkit-scrollbar-thumb {
    background: var(--secondary, #94a3b8);
    border-radius: 10px;
  }

  /* Messages */
  .leona-message {
    display: flex;
    gap: 8px;
    max-width: 88%;
    animation: msgIn 0.25s ease;
  }

  @keyframes msgIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .leona-message.leona-bot {
    align-self: flex-start;
  }

  .leona-message.leona-user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .leona-message-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2px;
  }

  .leona-message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .leona-message.leona-user .leona-message-avatar {
    background: #1e3a5f;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .leona-message-content {
    background: #fff;
    padding: 10px 13px;
    border-radius: 4px 14px 14px 14px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    color: var(--text-color, #333);
  }

  .leona-message.leona-user .leona-message-content {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 100%);
    color: #fff;
    border-radius: 14px 4px 14px 14px;
    box-shadow: 0 2px 6px rgba(30, 58, 95, 0.2);
  }

  .leona-message-content p {
    margin: 0 0 4px 0;
    font-size: 13px;
    line-height: 1.55;
  }

  .leona-message-content p:last-child {
    margin-bottom: 0;
  }

  .leona-message-content a {
    color: #3b82f6;
    text-decoration: underline;
  }

  .leona-message.leona-user .leona-message-content a {
    color: #93c5fd;
  }

  /* Quick Actions */
  .leona-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 4px 0;
  }

  .leona-quick-btn {
    padding: 6px 14px;
    background: #fff;
    border: 1px solid #d1d9e6;
    border-radius: 16px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #1e3a5f;
    font-weight: 500;
  }

  .leona-quick-btn:hover {
    background: #1e3a5f;
    color: #fff;
    border-color: #1e3a5f;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(30, 58, 95, 0.2);
  }

  /* Footer */
  .leona-popup-footer {
    padding: 10px 12px;
    background: #fff;
    border-top: 1px solid #e8ecf1;
  }

  .leona-input-form {
    display: flex;
    gap: 8px;
  }

  .leona-input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid #d1d9e6;
    border-radius: 20px;
    font-size: 13px;
    outline: none;
    transition: all 0.2s ease;
    background: #f5f7fa;
    color: var(--text-color, #333);
  }

  .leona-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    background: #fff;
  }

  .leona-input::placeholder {
    color: #94a3b8;
    font-size: 13px;
  }

  .leona-send-btn {
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 100%);
    border: none;
    border-radius: 12px;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .leona-send-btn:hover {
    transform: scale(1.06);
    box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
  }

  .leona-send-btn:active {
    transform: scale(0.95);
  }

  .leona-send-btn svg {
    width: 16px;
    height: 16px;
  }

  /* Typing */
  .leona-typing {
    display: flex;
    gap: 5px;
    padding: 8px 12px;
  }

  .leona-typing span {
    width: 8px;
    height: 8px;
    background: var(--secondary, #94a3b8);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
  }

  .leona-typing span:nth-child(1) {
    animation-delay: 0s;
  }
  .leona-typing span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .leona-typing span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes bounce {
    0%,
    60%,
    100% {
      transform: translateY(0);
    }
    30% {
      transform: translateY(-8px);
    }
  }

  /* Mobile */
  @media (max-width: 480px) {
    #leona-ai-widget {
      bottom: 16px;
      right: 16px;
    }

    .leona-help-bubble {
      font-size: 12px;
      padding: 6px 12px;
    }

    .leona-fab {
      width: 52px;
      height: 52px;
    }

    .leona-fab-img {
      width: 44px;
      height: 44px;
    }

    .leona-popup {
      width: calc(100vw - 32px);
      height: calc(100vh - 100px);
      bottom: 60px;
      right: -8px;
      border-radius: 20px;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("leona-toggle-btn");
    const closeBtn = document.getElementById("leona-close-btn");
    const popup = document.getElementById("leona-popup");
    const chatIcon = toggleBtn?.querySelector(".chat-icon");
    const closeIcon = toggleBtn?.querySelector(".close-icon");
    const helpBubble = document.querySelector(
      ".leona-help-bubble",
    ) as HTMLElement;
    const form = document.getElementById("leona-form");
    const input = document.getElementById("leona-input") as HTMLInputElement;
    const messagesContainer = document.getElementById("leona-messages");
    const quickBtns = document.querySelectorAll(".leona-quick-btn");

    // ---- Session & History Persistence ----
    const STORAGE_SESSION_KEY = "leona_session_id";
    const STORAGE_HISTORY_KEY = "leona_chat_history";
    const MAX_HISTORY = 50; // max messages to keep

    interface ChatMessage {
      text: string;
      isUser: boolean;
    }

    // Get or create persistent session ID
    function getSessionId(): number {
      const stored = sessionStorage.getItem(STORAGE_SESSION_KEY);
      if (stored) return parseInt(stored, 10);
      const newId = Math.floor(Math.random() * 1_000_000);
      sessionStorage.setItem(STORAGE_SESSION_KEY, String(newId));
      return newId;
    }

    let sessionId = getSessionId();

    // Load chat history from sessionStorage
    function loadHistory(): ChatMessage[] {
      try {
        const raw = sessionStorage.getItem(STORAGE_HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    // Save chat history to sessionStorage
    function saveHistory(history: ChatMessage[]) {
      const trimmed = history.slice(-MAX_HISTORY);
      sessionStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(trimmed));
    }

    // ---- End Persistence ----

    // Reset chat to welcome state (clear dynamic messages, show welcome + quick actions)
    function resetChatToWelcome() {
      // Remove all dynamically added messages (keep only the original welcome + quick actions)
      const allMessages = messagesContainer?.querySelectorAll(".leona-message");
      const quickActions = messagesContainer?.querySelector(
        ".leona-quick-actions",
      );

      allMessages?.forEach((msg, index) => {
        if (index === 0) {
          // First bot message is the static welcome message â€” show it
          (msg as HTMLElement).style.display = "";
        } else {
          // Remove dynamically added messages
          msg.remove();
        }
      });

      // Show quick action buttons again
      if (quickActions) (quickActions as HTMLElement).style.display = "";

      // Clear typing indicator if any
      document.getElementById("leona-typing")?.remove();

      // Clear UI history but keep session ID so backend conversation stays connected
      sessionStorage.removeItem(STORAGE_HISTORY_KEY);
    }

    function togglePopup() {
      const isHidden = popup?.classList.contains("hidden");

      if (isHidden) {
        // Reset to welcome state every time chat is opened
        resetChatToWelcome();

        popup?.classList.remove("hidden");
        chatIcon?.classList.add("hidden");
        closeIcon?.classList.remove("hidden");
        if (helpBubble) helpBubble.style.display = "none";
        input?.focus();
      } else {
        popup?.classList.add("hidden");
        chatIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
        if (helpBubble) helpBubble.style.display = "block";
      }
    }

    toggleBtn?.addEventListener("click", togglePopup);
    closeBtn?.addEventListener("click", togglePopup);

    function addMessage(
      text: string,
      isUser: boolean = false,
      persist: boolean = true,
    ) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `leona-message ${isUser ? "leona-user" : "leona-bot"}`;

      let avatarHtml: string;
      if (isUser) {
        avatarHtml = `<div class="leona-message-avatar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>`;
      } else {
        avatarHtml = `<div class="leona-message-avatar"><img src="/assets/img/leona.png" alt="Leona" /></div>`;
      }

      messageDiv.innerHTML = `
        ${avatarHtml}
        <div class="leona-message-content"><p>${text}</p></div>
      `;

      messagesContainer?.appendChild(messageDiv);
      messagesContainer?.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: "smooth",
      });

      // Save to history
      if (persist) {
        const history = loadHistory();
        history.push({ text, isUser });
        saveHistory(history);
      }
    }

    function showTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "leona-message leona-bot";
      typingDiv.id = "leona-typing";
      typingDiv.innerHTML = `
        <div class="leona-message-content">
          <div class="leona-typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      messagesContainer?.appendChild(typingDiv);
      messagesContainer?.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: "smooth",
      });
    }

    function removeTyping() {
      document.getElementById("leona-typing")?.remove();
    }

    async function sendToLeona(userMessage: string): Promise<string> {
      try {
        const res = await fetch("/api/leona", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            session_id: sessionId,
            message: userMessage,
          }),
        });

        const data = await res.json();
        return (
          data.output ||
          "Maaf, saya tidak bisa memproses permintaan Anda saat ini."
        );
      } catch {
        return "Chatbot sedang tidak tersedia. Silakan coba lagi nanti.";
      }
    }

    async function handleSend(message: string) {
      if (!message.trim()) return;

      // Hide welcome & quick actions on first real message
      const welcomeMsg = messagesContainer?.querySelector(
        ".leona-message.leona-bot",
      );
      const quickActions = messagesContainer?.querySelector(
        ".leona-quick-actions",
      );
      if (welcomeMsg) (welcomeMsg as HTMLElement).style.display = "none";
      if (quickActions) (quickActions as HTMLElement).style.display = "none";

      addMessage(message, true);
      if (input) input.value = "";
      showTyping();

      const response = await sendToLeona(message);

      removeTyping();
      addMessage(response, false);
    }

    form?.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = input?.value.trim();
      if (!message) return;
      handleSend(message);
    });

    quickBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const message = btn.getAttribute("data-message");
        if (message) {
          handleSend(message);
        }
      });
    });
  });
</script>
