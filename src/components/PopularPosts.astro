---
import { getCollection } from 'astro:content';
import FormattedDate from './FormattedDate.astro';

export interface Props {
  category: string | string[];
  limit?: number;
}

const { category, limit = 4 } = Astro.props;

// Get the current URL to extract the slug
const currentPath = Astro.url.pathname;
const currentSlug = currentPath.split('/').filter(Boolean).pop();

// Create an array of categories regardless of input type
const categories = Array.isArray(category) ? category : [category];

// Get all blog posts
const allPosts = await getCollection('blog');

// Find popular posts based on matching categories, excluding the current post
const popularPosts = allPosts
  .filter((post) => {
    // Skip the current post by comparing slug in URL path
    if (post.data.slug === currentSlug) return false;

    // Get post categories, ensuring we handle both string and array
    const postCats = Array.isArray(post.data.category) ? post.data.category : [post.data.category];

    // Check if there's any category match
    return categories.some((category) =>
      postCats.some((postCategory) => postCategory.toLowerCase() === category.toLowerCase()),
    );
  })
  // Sort by publication date (latest first)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
  // Get the top posts based on limit
  .slice(0, limit);
---

{
  popularPosts.length > 0 && (
    <div class="sidebar-section">
      <h3 class="sidebar-title">Recommended Articles</h3>
      <ul class="popular-posts-list">
        {popularPosts.map((post) => (
          <li class="popular-post-item">
            {post.data.heroImage && (
              <div class="popular-post-thumbnail">
                <img 
                  src={post.data.heroImage} 
                  alt={post.data.title} 
                  loading="lazy" 
                  decoding="async" 
                />
              </div>
            )}
            <div class="popular-post-content">
              <a href={`/posts/${post.data.slug}`}>{post.data.title}</a>
              <div class="popular-post-date">
                <FormattedDate date={post.data.pubDate} />
              </div>
            </div>
          </li>
        ))}
      </ul>
    </div>
  )
}

<style>
  .sidebar-section {
    background: transparent;
    border: 1px solid var(--bg-tags);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: border-color .2s ease;
  }

  .sidebar-section:hover { 
    border-color: color-mix(in oklab, var(--text-color) 20%, var(--bg-tags));
  }

  .sidebar-title {
    font-size: 0.88rem;
    font-weight: 900;
    color: var(--text-color);
    margin-bottom: .75rem;
    letter-spacing: -0.01em;
  }

  .popular-posts-list { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
  }

  .popular-post-item {
    margin-bottom: .75rem; 
    padding-bottom: .75rem;
    border-bottom: 1px solid var(--bg-tags);
    display: flex;
    gap: .7rem;
    align-items: flex-start;
  }

  .popular-post-item:last-child { 
    margin-bottom: 0; 
    padding-bottom: 0; 
    border-bottom: none; 
  }

  .popular-post-thumbnail {
    width: 64px;
    height: 64px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
    background-color: var(--bg-tags);
  }

  .popular-post-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .popular-post-item:hover .popular-post-thumbnail img {
    transform: scale(1.05);
  }

  .popular-post-content { 
    flex: 1; 
    min-width: 0; 
  }

  .popular-post-item a {
    color: var(--text-color); 
    text-decoration: none;
    font-size: 0.86rem;
    font-weight: 700;
    opacity: .9; 
    line-height: 1.4; 
    transition: color .2s ease, opacity .2s ease;
    display: block;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .popular-post-item a:hover { 
    opacity: 1; 
    color: var(--primary); 
  }

  .popular-post-date {
    font-size: 0.72rem;
    color: var(--text-color);
    opacity: .5;
    margin-top: .25rem;
  }
</style>